<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- For Mobile Devices -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<title>Boost.SIMD: Memory Alignment</title>
<!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link rel="icon" href="numscale_icon.png">
<link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="numscale.css" rel="stylesheet" type="text/css"/>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="numscale.js"></script>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
<div class="container">
<div class="navbar-header responsive-logo">
<a class="navbar-brand" style="width: 10%" href="https://github.com/NumScale/boost.simd">Boost.SIMD </a>
<a href="http://www.numscale.com/" title="Numscale" style="display: block; width: 25%; text-align: right; float: right"><img src="numscale.png" alt="Numscale" style="width:100%; padding-top: 10px; padding-bottom: 10px; " align="right"></a>
</div>
</div>
</nav>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div class="content" id="content">
<div class="container">
<div class="row">
<div class="col-sm-12 panel " style="padding-bottom: 35px;">
<div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="quickstart.html"><span>Quick&#160;Start</span></a></li>
      <li><a href="tutorials.html"><span>Tutorials</span></a></li>
      <li><a href="faq.html"><span>FAQ</span></a></li>
      <li><a href="modules.html"><span>Reference&#160;documentation</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Memory Alignment </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#memory-what-is">What is Memory Alignment</a></li>
<li class="level1"><a href="#memory-how-to-align">How to Align Memory Manually?</a></li>
<li class="level1"><a href="#memory-boost-align">How to Align Memory using Boost.Align</a></li>
<li class="level1"><a href="#memory-vector">How to use an aligned memory allocator with `std::vector`</a></li>
</ul>
</div>
<div class="textblock"><p>All of the previous tutorials assumed that the memory allocated for the input and output buffers was correctly aligned. Depending on your memory allocator and architecture, this may not always be true. In this tutorial we will discuss memory alignment and demonstrate how to ensure that your memory is always correctly aligned.</p>
<h1><a class="anchor" id="hello-objectives"></a>
Objectives</h1>
<hr/>
<p>In this tutorial we will:</p><ul>
<li><a href="#memory-what-is">Explain what memory alignemnt is</a></li>
<li><a href="#memory-how-to-align">Demonstrate how to align memory</a></li>
<li><a href="#memory-boost-align">Demonstrate how to align memory using Boost.Align</a></li>
<li><a href="#memory-vector">Demonstrate how to use an aligned memory allocator with STL containers</a></li>
</ul>
<h1><a class="anchor" id="memory-what-is"></a>
What is Memory Alignment</h1>
<p>In order to fully understand memory alignment and how to maximise performance of your software by ensuring mempry alignment, please read this excellent article by <a href="http://www.ibm.com/developerworks/library/pa-dalign/">IBM</a>. Although this article focuses on PowerPC processors, its conclusions are valid on many other architectures. <b>Boost.SIMD</b> gives you portabililty accross many architectures, in order to have the best performance possible across a range of architectures, it is worth considering the alignment requirements of all target architectures.</p>
<h1><a class="anchor" id="memory-how-to-align"></a>
How to Align Memory Manually?</h1>
<p>It is possible to align memory yourself using <code>std::align</code>. In the following example, we allocate memory and store it in a unique_ptr. This pointer is then shifted until it is aligned on the requested boundary. This means that the allocated buffer must be larger than the size required, at least <code>pack_t::alignment</code> (the required alignment for a pack of this type on the target architecture) bytes larger.</p>
<div class="fragment"><div class="line">    <span class="keyword">namespace </span><a class="code" href="namespaceboost_1_1simd.html">bs</a> = <a class="code" href="namespaceboost_1_1simd.html">boost::simd</a>;</div>
<div class="line">    <span class="keyword">using</span> pack_t = <a class="code" href="singletonboost_1_1simd_1_1pack.html">bs::pack&lt;int&gt;</a>;</div>
<div class="line">    std::size_t num_elements = 1024;</div>
<div class="line">    std::size_t alignment = pack_t::alignment;</div>
<div class="line">    std::size_t buffer_size = num_elements + alignment;</div>
<div class="line">    std::unique_ptr&lt;char[]&gt; ptr(<span class="keyword">new</span> <span class="keywordtype">char</span>[buffer_size]);</div>
<div class="line">    <span class="keywordtype">void</span> *pv = ptr.get();</div>
<div class="line">    <span class="keywordflow">if</span>(std::align(alignment, num_elements, pv, buffer_size) == <span class="keyword">nullptr</span>){</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot; alignment failed &quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
</div><!-- fragment --><p> As you can see, this is errorprone, difficult and quite annoying to do. Also, <code>std::align</code> is not unviersally supported even amoong modern compilers! Therefore, the easiest way to align memory is to use an aligned memory allocator such as that provided by Boost.Align.</p>
<h1><a class="anchor" id="memory-boost-align"></a>
How to Align Memory using Boost.Align</h1>
<p>The allocator provided by Boost.Align guarantees to return a pointer which is aligned on the required boundary and you don't need to worry about allocating extra space in the buffer to account for the required alignement as in the previous section.</p>
<table  align="center" width="90%" class="table-striped ">
<tr>
<th><dl class="section note">
<dt>Note</dt>
<dd>The additional template parameter passed to the <code>std::unique_ptr</code>, this is the associated delete function corresponding to the aligned allocator. </dd>
</dl>
</th></tr>
</table>
<div class="fragment"><div class="line">    <span class="keyword">namespace </span><a class="code" href="namespaceboost_1_1simd.html">bs</a> = <a class="code" href="namespaceboost_1_1simd.html">boost::simd</a>;</div>
<div class="line">    <span class="keyword">namespace </span>ba = boost::alignment;</div>
<div class="line">    <span class="keyword">using</span> pack_t = <a class="code" href="singletonboost_1_1simd_1_1pack.html">bs::pack&lt;int&gt;</a>;</div>
<div class="line">    std::size_t num_elements = 1024;</div>
<div class="line">    std::size_t alignment = pack_t::alignment;</div>
<div class="line">    std::unique_ptr&lt;char[], ba::aligned_delete&gt; ptr2((<span class="keywordtype">char</span>*)ba::aligned_alloc(alignment, num_elements));</div>
</div><!-- fragment --> <h1><a class="anchor" id="memory-vector"></a>
How to use an aligned memory allocator with `std::vector`</h1>
<p>The C++ STL containers allow you to use a custom memory allocator by passing an additional template argument during the declaration, in a similar manner to the previous example using <code>std::unique_ptr</code>. You can use Boost.Align with an <code>std::vector</code> as follows:</p>
<div class="fragment"><div class="line">    <span class="keyword">namespace </span><a class="code" href="namespaceboost_1_1simd.html">bs</a> = <a class="code" href="namespaceboost_1_1simd.html">boost::simd</a>;</div>
<div class="line">    <span class="keyword">namespace </span>ba = boost::alignment;</div>
<div class="line">    <span class="keyword">using</span> pack_t = <a class="code" href="singletonboost_1_1simd_1_1pack.html">bs::pack&lt;int&gt;</a>;</div>
<div class="line">    std::size_t num_elements = 1024;</div>
<div class="line">    std::size_t alignment = pack_t::alignment;</div>
<div class="line">    std::vector&lt;int, ba::aligned_allocator&lt;int, pack_t::alignment&gt;&gt; input_buffer(num_elements);</div>
</div><!-- fragment --><p> The data stored in this vetcor may be used by Boost.SIMD as an input or output buffer. </p>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>
Generated on Fri Sep 9 2016 11:30:37 for Boost.SIMD by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
